/**
 * Formatted field widget
 * @version 1.1.0
 * @author mfyodorov
 * @license MIT
 */
function FormattedField(e,t){function r(){for(var t in d.replace)e.value=e.value.replace(d.replace[t].self,d.replace[t].value);if(d.pattern){d.digits=s(e.value);var r=l();Array.isArray(r)||(r=[r]);for(var t in r){d.currentPattern=r[t],d.allowed=c(d.currentPattern,d.replace),d.maxlength=d.currentPattern.length;var u=n(e.value);if(u.flag)return;if("replace"===u.type)break}e.value=a()}}function n(e){if(e.length>d.maxlength)return{flag:!1,type:"length"};for(var t in e){if(!o(d.currentPattern[t]).test(e[t]))return{flag:!1,type:"pattern"};if(!1!==u(t,e[t]))return{flag:!1,type:"replace"}}return{flag:!0}}function a(){var e="",t=0;for(var r in d.currentPattern){if(d.digits.length<=t)break;if("9"==d.currentPattern[r]){var n=u(r,d.digits[t]);e+=!1!==n?n:d.digits[t],t++}else e+=d.currentPattern[r]}return e}function l(){for(var e in d.pattern)if("default"!=e&&!0===new RegExp("^"+e).test(d.digits))return d.pattern[e];return d.pattern["default"]}function u(t,r){if(t=parseInt(t)+1,d.customReplace.hasOwnProperty(t))for(var n in d.customReplace[t])if(d.customReplace[t][n].hasOwnProperty("self")){if((a=new RegExp(d.customReplace[t][n].self)).test(r))return d.customReplace[t][n].value}else{if(!d.customReplace[t][n].hasOwnProperty("all"))return d.customReplace[t][n].value;var a=new RegExp(d.customReplace[t][n].all);if(a.test(e.value))return d.customReplace[t][n].value}return!1}function i(e){d.pattern.hasOwnProperty("default")||(d.pattern["default"]=[e.replace(/\?/g,"")]);var t=e.indexOf("?");-1!==t?(newPattern=(t>1?e.substring(0,t-1):"")+(t<e.length?e.substring(t+1):""),d.pattern["default"].push(newPattern.replace(/\?/g,"")),i(newPattern)):d.pattern["default"]=d.pattern["default"].reverse()}function c(e,t){var r={};for(var n in e)f(e[n],r);return r}function f(e,t){-1===Object.keys(t).indexOf(e)?t[e]={regexp:o(e,"g"),count:1}:++t[e].count}function o(e,t){var r=p(e);return new RegExp(r,t)}function p(e){var t={9:"\\d"," ":"\\s","+":"\\+","(":"\\(",")":"\\)",".":"\\."};return t.hasOwnProperty(e)?t[e]:e}function s(e){return e.replace(/\D*/g,"")}function g(e,t,r,n){var a=n.value,l=n.selectionEnd&&n.selectionEnd-n.selectionStart>0;e=v(e,r);for(var u in t){var i=t[u].regexp.test(e);if(i){if(!l){var c=a&&a.match(t[u].regexp)?a.match(t[u].regexp).length:0;i=t[u].count>c}return i}}return!1}function v(e,t){for(var r in t)if("string"==typeof t[r].self&&t[r].self===e&&t[r].value)return t[r].value;return e}function h(e){return null==e.which?e.keyCode<32?null:String.fromCharCode(e.keyCode):0!=e.which&&0!=e.charCode?e.which<32?null:String.fromCharCode(e.which):null}var d={replace:function(e){var t=[];return"object"==typeof e&&(Array.isArray(e)?t=e:t.push(e),t=t.filter(function(e){if(e.self)return{self:e.self,value:"string"==typeof e.value?e.value:""}})),t}(t.replace),customReplace:t.customReplace||{},pattern:!1,currentPattern:"",digits:"",minlength:t.minlength||!1,maxlength:"",allowed:{}};t.pattern&&(d.pattern=t.customPattern||{},i(t.pattern)),function(){d.minlength&&e.setAttribute("pattern",".{"+d.minlength+",}"),r(),d.pattern&&(e.onkeypress=function(t){if(!((t=t||event).ctrlKey||t.altKey||t.metaKey)){var r=h(t);if(null!=r)return g(r,d.allowed,d.replace,e)}}),e.onkeyup=function(e){r()}}()}